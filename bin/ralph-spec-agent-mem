#!/usr/bin/env node

/**
 * ralph-spec-agent-mem - CLI Installer
 *
 * Cross-platform installer for Ralph Loop Methodology
 * Supports: Global installation, Project-level installation, Both
 */

const { spawn } = require('child_process');
const path = require('path');
const fs = require('fs');

const isWindows = process.platform === 'win32';
const rootDir = path.join(__dirname, '..');

// Parse command line arguments
const args = process.argv.slice(2);
const command = args[0] || 'install';

// Color utilities
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  cyan: '\x1b[36m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  blue: '\x1b[34m'
};

function colorize(text, color) {
  return `${color}${text}${colors.reset}`;
}

function printBanner() {
  console.log(colorize(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                              ‚ïë
‚ïë               RALPH LOOP METHODOLOGY                         ‚ïë
‚ïë            Spec-Driven Agent Memory System                   ‚ïë
‚ïë                                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
`, colors.cyan));
  console.log();
}

function printHelp() {
  printBanner();
  console.log(colorize('Usage:', colors.bright));
  console.log('  ralph-spec-agent-mem [command] [options]');
  console.log();
  console.log(colorize('Commands:', colors.bright));
  console.log('  install                 Interactive installer (default)');
  console.log('  install --global        Global installation only');
  console.log('  install --project       Project-level installation only');
  console.log('  help                    Show this help message');
  console.log('  version                 Show package version');
  console.log();
  console.log(colorize('Examples:', colors.bright));
  console.log('  npx ralph-spec-agent-mem');
  console.log('  npx ralph-spec-agent-mem install');
  console.log('  npx ralph-spec-agent-mem install --global');
  console.log();
  console.log(colorize('What is Ralph Loop?', colors.blue));
  console.log('  9-phase autonomous feature development system:');
  console.log('    1. Interview ‚Üí 2. Think Critically ‚Üí 3. Plan');
  console.log('    4. Branch ‚Üí 5. Implement ‚Üí 5.5 Verify (E2E)');
  console.log('    6. PR ‚Üí 7. Merge ‚Üí 8. Wrap-Up');
  console.log();
  console.log(colorize('Documentation:', colors.blue));
  console.log('  https://github.com/edumesones/not-code-claude-runs-you-pilot');
  console.log();
}

function printVersion() {
  const pkg = require(path.join(rootDir, 'package.json'));
  console.log(`ralph-spec-agent-mem v${pkg.version}`);
}

function runInstaller(installType = null) {
  printBanner();

  const installerScript = isWindows ? 'install.ps1' : 'install.sh';
  const installerPath = path.join(rootDir, installerScript);

  // Check if installer exists
  if (!fs.existsSync(installerPath)) {
    console.error(colorize(`‚ùå Installer not found: ${installerScript}`, colors.red));
    console.error('Please reinstall the package: npm install -g ralph-spec-agent-mem');
    process.exit(1);
  }

  console.log(colorize('üöÄ Starting Ralph Loop installer...', colors.green));
  console.log();

  let cmd, cmdArgs;

  if (isWindows) {
    cmd = 'powershell.exe';
    cmdArgs = [
      '-ExecutionPolicy', 'Bypass',
      '-File', installerPath
    ];
  } else {
    cmd = 'bash';
    cmdArgs = [installerPath];
  }

  // Add install type if specified
  if (installType === '--global') {
    // Pre-answer: 1 (global only)
    console.log(colorize('üì¶ Global installation mode', colors.yellow));
  } else if (installType === '--project') {
    // Pre-answer: 2 (project only)
    console.log(colorize('üì¶ Project-level installation mode', colors.yellow));
  }

  const installer = spawn(cmd, cmdArgs, {
    cwd: rootDir,
    stdio: 'inherit',
    shell: true
  });

  installer.on('error', (err) => {
    console.error(colorize(`‚ùå Failed to start installer: ${err.message}`, colors.red));
    process.exit(1);
  });

  installer.on('exit', (code) => {
    if (code === 0) {
      console.log();
      console.log(colorize('‚úÖ Installation complete!', colors.green));
      console.log();
      console.log(colorize('Next steps:', colors.bright));
      console.log('  1. Read the docs: cat ~/.claude/ralph-loop/docs/feature_cycle.md');
      console.log('  2. Create a feature: mkdir -p docs/features/FEAT-001');
      console.log('  3. Run Ralph Loop: ./ralph-feature.sh FEAT-001');
      console.log();
    } else {
      console.error(colorize(`‚ùå Installation failed with code ${code}`, colors.red));
      process.exit(code || 1);
    }
  });
}

// Main command router
switch (command) {
  case 'help':
  case '--help':
  case '-h':
    printHelp();
    break;

  case 'version':
  case '--version':
  case '-v':
    printVersion();
    break;

  case 'install':
    const installType = args[1]; // --global or --project
    runInstaller(installType);
    break;

  default:
    // No command = default to install
    runInstaller();
    break;
}
