#!/bin/bash
###############################################################################
# Git Pre-Commit Hook - Browser Automation Security
#
# MANDATORY security scan before git commit
# Prevents secret leakage in screenshots, console logs, network logs
#
# Installation:
#   bash .memory-system/scripts/install-git-hooks.sh
###############################################################################

set -e

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}[PRE-COMMIT] Running browser automation security scan...${NC}"

# Get the root of the git repository
GIT_ROOT=$(git rev-parse --show-toplevel)

# Path to security filter script
SECURITY_SCRIPT="$GIT_ROOT/.memory-system/scripts/security-filters.sh"

# Check if security script exists
if [ ! -f "$SECURITY_SCRIPT" ]; then
  echo -e "${RED}[PRE-COMMIT] âŒ Security script not found: $SECURITY_SCRIPT${NC}"
  echo -e "${RED}[PRE-COMMIT] Run: bash .memory-system/install.sh${NC}"
  exit 1
fi

# Check if docs/features directory exists
if [ ! -d "$GIT_ROOT/docs/features" ]; then
  echo -e "${GREEN}[PRE-COMMIT] â„¹ï¸  No features directory, skipping security scan${NC}"
  exit 0
fi

# Run security scan on staged files only
echo -e "${YELLOW}[PRE-COMMIT] Scanning staged files for secrets...${NC}"

# Get list of staged files that match patterns
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | \
  grep -E 'docs/features/.*/test-results/.*\.(txt|json|md|png|jpg)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo -e "${GREEN}[PRE-COMMIT] âœ… No test result files staged, skipping scan${NC}"
  exit 0
fi

# Scan each staged file
FAILED=0
for file in $STAGED_FILES; do
  if [ -f "$GIT_ROOT/$file" ]; then
    echo -e "${YELLOW}[PRE-COMMIT] Scanning: $file${NC}"

    # Run security scan
    if ! bash "$SECURITY_SCRIPT" scan "$GIT_ROOT/$file"; then
      FAILED=$((FAILED + 1))
      echo -e "${RED}[PRE-COMMIT] âŒ Secrets detected in: $file${NC}"
    fi
  fi
done

# Check results
if [ $FAILED -gt 0 ]; then
  echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${RED}â•‘                    ğŸš¨ COMMIT BLOCKED ğŸš¨                        â•‘${NC}"
  echo -e "${RED}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
  echo -e "${RED}â•‘ Found secrets in $FAILED files                                      â•‘${NC}"
  echo -e "${RED}â•‘                                                                â•‘${NC}"
  echo -e "${RED}â•‘ Action Required:                                               â•‘${NC}"
  echo -e "${RED}â•‘ 1. Run security filters to redact secrets:                    â•‘${NC}"
  echo -e "${YELLOW}â•‘    bash .memory-system/scripts/security-filters.sh filter-all \\  ${NC}"
  echo -e "${YELLOW}â•‘         docs/features/FEAT-XXX/test-results                   ${NC}"
  echo -e "${RED}â•‘                                                                â•‘${NC}"
  echo -e "${RED}â•‘ 2. Review filtered files manually                             â•‘${NC}"
  echo -e "${RED}â•‘ 3. Re-stage files: git add <files>                            â•‘${NC}"
  echo -e "${RED}â•‘ 4. Retry commit                                               â•‘${NC}"
  echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  exit 1
fi

echo -e "${GREEN}[PRE-COMMIT] âœ… Security scan passed - no secrets detected${NC}"
exit 0
